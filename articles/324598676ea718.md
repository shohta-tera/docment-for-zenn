---
title: "Kubernetesã«yugabyteDBã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["helm", "kubernetes", "yugabyteDB", "postgreSQL"]
published: false
---

# ã¯ã˜ã‚ã«

# ç’°å¢ƒ
- WSL2: Ver20
- Helm: v3.6.1

## äº‹å‰æº–å‚™
kind(Kubernetes in docker)ã«ã‚ˆã‚‹Clusterã‚’æ§‹æˆã™ã‚‹
```yaml:cluster-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  apiServerAddress: "127.0.0.1"
  apiServerPort: 6443
nodes:
- role: control-plane
- role: worker
```

### Clusterã®ä½œæˆ
`kind create cluster --config=(path)/clustr-config.yaml`

### Helmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
[helmã®å…¬å¼](https://helm.sh/docs/intro/install/)ã‚’å‚è€ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -
sudo apt-get install apt-transport-https --yes
echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm
```

## YugabyteDBã«ã¤ã„ã¦

### YugabyteDBã®æ¦‚è¦

YugabyteDBã¯PostgreSQLäº’æ›ã®åˆ†æ•£SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚
è©³ç´°æƒ…å ±ã¯ä»¥ä¸‹ã®è¨˜äº‹ã«ã¦ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
- https://qiita.com/tzkoba/items/593d0d3dbfa932da6dd0

### YugabyteDBã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ç›®çš„ã€‚

Kubernetes Clusterä¸Šã«ã‚¸ãƒ§ãƒ–ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹Airflowã‚’ä½¿ç”¨ã—ãŸã„ã€‚ã¾ãŸã€Airflowã®ã‚¸ãƒ§ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã¯PostgreSQLã«ä¿ç®¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ãã®ãŸã‚ã€ä»Šå›Airflowã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«PostgreSQLã§ã¯ãªãã€YugabyteDBã‚’å…¥ã‚Œã¦æ¤œè¨¼ã—ã¦ã¿ãŸã‹ã£ãŸã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã™ã€‚

### YugabyteDBã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

- `database` namespaceã®ä½œæˆã€‚
```
kubectl create namespace database
```

- chartãƒ¬ãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
```
helm repo add yugabytedb https://charts.yugabyte.com
```

- install
```
helm install yugabyte yugabytedb/yugabyte \
--set resource.master.requests.cpu=0.5,resource.master.requests.memory=0.5Gi,\
resource.tserver.requests.cpu=0.5,resource.tserver.requests.memory=0.5Gi --namespace database
```

- ç¢ºèª
```
kubectl exec -n database -it yb-tserver-0 -- /home/yugabyte/bin/ysqlsh -h yb-tserver-0.yb-tservers.database
```
shellã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã•ãˆã§ãã¦ã—ã¾ãˆã°ã€ã‚ã¨ã¯æ™®é€šã®PostgreSQLã®ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ãˆã¾ã™ã€‚  
ä»Šå›ã¯Apache Airflowã‚’ä½¿ã„ãŸã„ã®ã§ã€Airflowç”¨ã®Databaseã¨Userã‚’ä½œæˆã—ã¾ã™ã€‚
```
yugabyte=# CREATE USER su_airflow PASSWORD 'su_airflow';
yugabyte=# CREATE DATABASE airflow;
yugabyte=# GRANT ALL PRIVILEGES ON DATABASE airflow TO su_airflow; 
```

## YugabyteDBã¯å®Œå…¨ã«PostgreSQLå¯¾å¿œã§ã¯ãªã„ã€‚

**YugabyteDB currently doesnâ€™t support the ALTER TABLE ADD PRIMARY KEY command (GitHub Issue #1104) which means that the Airflow initdb command wonâ€™t work out of the box.**
ã¨YugabyteDBã®å…¬å¼Blogã«è¨˜è¼‰ãŒã‚ã‚Šã€æ®‹å¿µãŒã‚‰Airflowã®Backendã«YugabyteDBã¯ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

# å‚è€ƒURL
- kind: https://kind.sigs.k8s.io/docs/user/using-wsl2/
- yugabyteDB: https://docs.yugabyte.com/latest/deploy/kubernetes/single-zone/oss/helm-chart/#install-yugabytedb
- helm: https://helm.sh/docs/intro/install/
---
title: "Pgbouncerã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹Helmãƒãƒ£ãƒ¼ãƒˆã‚’è‡ªä½œã™ã‚‹"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes", "helm", "pgbouncer"]
published: true
---

# ã¯ã˜ã‚ã«

ä»¥å‰ã®Airflowå°å…¥ã®è¨˜äº‹ã«é–¢é€£ã—ã¾ã™ã€‚  
https://zenn.dev/shorter/articles/dcf694061bb4bf
ã‚¸ãƒ§ãƒ–ç®¡ç†ã®ãŸã‚ã®OSSã§ã‚ã‚‹Airflowã‚’å°å…¥ã—ã¦ãŠã‚Šã€ã‚¸ãƒ§ãƒ–ã®æ•°ã‚„Postgresã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¢—ãˆã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«é­é‡ã—ã¦ã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ãªã‹ã£ãŸã‚Šã€ãã‚‚ãã‚‚ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œãªã„ã€‚ã‚ˆã†ãªçŠ¶æ³ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

```
FATAL: Sorry, too many clients aleready
```

ã“ã‚Œã¯ã€Airflowè‡ªä½“ã‚„WorkerãŒPostgresã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„æœãŸã™ã“ã¨ã§å‡ºã‚‹ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã‚’ç”¨ã„ã¦æ—¢å­˜ã®æ¥ç¶šç¢ºç«‹æ¸ˆã¿ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã¾ã‚ã™ã“ã¨ãŒé¸æŠè‚¢ã¨ã—ã¦ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€Airflowã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚æ¨å¥¨äº‹é …ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚  
https://airflow.apache.org/docs/apache-airflow/stable/howto/set-up-database.html#setting-up-a-postgresql-database

https://github.com/airflow-helm/charts
å…¬å¼ã®Helmãƒãƒ£ãƒ¼ãƒˆã‚’ç”¨ã„ã¦ã„ã‚Œã°ã€values.yamlã‚’ç·¨é›†ã—ã¦Pgbouncerã‚’æœ‰åŠ¹åŒ–ã™ã‚Œã°å°å…¥ã§ãã¾ã™ã€‚  
ã—ã‹ã—ä»¥å‰ã®è¨˜äº‹ã§ã¯ã€Bitnamiã«ã‚ˆã‚‹Postgres, Airflowã‚’å°å…¥ã—ãŸãŸã‚Pgbouncerã®é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸBitnamiã«ã‚ˆã‚‹Helmãƒãƒ£ãƒ¼ãƒˆã«ã‚‚Pgbouncerã¯ãªãã€ArtifactHUBã§Pgbouncerã«ã¤ã„ã¦æ¤œç´¢ã‚’ã—ã¦ã¿ã¦ã‚‚å¤ã„ã‚‚ã®ã°ã‹ã‚Šã§ã‚ã‚Šã¾ã—ãŸã€‚  
https://artifacthub.io/packages/search?ts_query_web=pgbouncer&sort=relevance&page=1

ãã®ãŸã‚ä»Šå›ã¯ã€Pgbouncerã‚’å°å…¥ã™ã‚‹ãŸã‚ã®Helmãƒãƒ£ãƒ¼ãƒˆã‚’è‡ªä½œã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚  
Helm chartå…¨ä½“ã¯ä»¥ä¸‹ã«ç½®ã„ã¦ã¾ã™ã€‚
https://github.com/shohta-tera/pgbouncer-helm-charts

## ç’°å¢ƒ

- WSL2: Ubuntu 20
- Docker: 4.10.1
- kind: kind v0.11.1 go1.16.4 linux/amd64

## Pgbouncerã®Containerã‚¤ãƒ¡ãƒ¼ã‚¸

Pgbouncerã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¯BitnamiãŒæä¾›ã™ã‚‹ã‚‚ã®ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ä»Šå›ã¯ã€md5èªè¨¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã ã‘ã§å®Ÿè£…ã—ã¾ã™ã€‚
https://github.com/bitnami/containers/tree/main/bitnami/pgbouncer

Pgbouncerã«å¿…è¦ã¨ãªã‚‹ç’°å¢ƒå¤‰æ•°ã¯ä»¥ä¸‹ã§ã™ã€‚
- POSTGRESQL_USERNAME: Postgresã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- POSTGRESQL_PASSWORDï¼š Postgresã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(Secretã«ä¿ç®¡ã—ã¾ã™)
- PGBOUNCER_POOL_MODEï¼š Pgbouncerã®è¨­å®šã€‚Airflowã§æ¨å¥¨ã•ã‚Œã¦ã„ã‚‹"transaction"ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
- PGBOUNCER_AUTH_QUERYï¼š ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒå¼µã‚‰ã‚ŒãŸå¾Œã®Query
- POSTGRESQL_HOSTï¼š æ¥ç¶šã™ã‚‹Postgresã®ãƒ›ã‚¹ãƒˆå
- PGBOUNCER_AUTH_FILEï¼š ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆ(Secretã«ä¿ç®¡ã—ã¾ã™)

ã¾ãŸPgbouncerã®å°å…¥ã®ãŸã‚ã«ã¯ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã§ã™ã€‚
- Deployment
- PodDisruptionBudget
- Secrets
- Service
- ServiceAccount

### values.yaml

https://github.com/shohta-tera/pgbouncer-helm-charts/blob/main/values.yaml

åŸºæœ¬çš„ã«ã¯ã€values.yamlã«ã‚ã‚‹è¨­å®šå€¤ã‚’å¤‰æ›´ã—ã¾ã™ã€‚  
ä»¥ä¸‹ã¯ä»£è¡¨çš„ãªã‚‚ã®ã®æŠœç²‹ã§ã™ã€‚  


```yaml
image:
  repository: bitnami/pgbouncer
  tag: 1.17.0-debian-11-r25
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 200m
    memory: 256Mi

  maxClientConnections: 2000

  poolSize: 5

  envVars:
    POSTGRESQL_USERNAME: postgres
    PGBOUNCER_POOL_MODE: transaction
    PGBOUNCER_AUTH_USER: pgbouncer
    PGBOUCCER_AUTH_QUERY: SELECT usename, passwd FROM pg_shadow WHERE usename = $1
    POSTGRESQL_HOST: postgres.database.svc.cluster.local
    PGBOUNCER_AUTH_FILE: /bitnami/pgbouncer/conf/userlist.txt

externalDatabase:
  host: postgres.database.svc.cluster.local
  port: 5432
```

## Deploy

ä»Šå›ã€Pgbouncerã¯databaseãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚‚ã®ã¨ã—ã€Airflowã‚„Postgresã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã¯`--set`ã‚³ãƒãƒ³ãƒ‰ã§å…¥åŠ›ã—ã¾ã™

```bash
helm upgrade pggboucer-airflow ./ \
  --namespace database \
  --install \
  --set auth.POSTGRESQL_PASSWORD=testPassword \
  --set auth.AIRFLOW_USERNAME=airflow \
  --set auth.AIRFLOW_PASSWORD=airflowPassword \
  --set pgbouncer.envVars.POSTGRESQL_HOST=postgresql-ha-pgpool.database.svc.cluster.local \
  --set externalDatabase.host=postgresql-ha-pgpool.database.svc.cluster.local \
  --set pgbouncer.image.tag=1.17.0-debian-11-r31
```

## å°å…¥å¾Œ

Pgbouncerã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã€å¤§å¹…ã«ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’å‰Šæ¸›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

*Before*
```
count | datname | usename
------+---------+-----------
  626 | airflow | airflow
    5 |         |
    3 | repmgr  | repmgr
    2 |         | repmgr
    2 |         | postgres
```
*After*
```
count | datname | usename
------+---------+-----------
   11 | airflow | airflow
    5 |         |
    3 | repmgr  | repmgr
    2 |         | repmgr
    2 |         | postgres
```

## ã•ã„ã”ã«

èªè¨¼ã‚¿ã‚¤ãƒ—ãŒ`md5`ã ã‘ã§ã‚ã£ãŸã‚Šã€SSLãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ã²ã¨ã¾ãšKubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã«Pgbouncerã‚’å°å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

https://github.com/bitnami/containers/tree/main/bitnami/pgbouncer
Bitnamiã®Pgbouncerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€èªè¨¼ã‚¿ã‚¤ãƒ—ã‚„SSLã«é–¢ã™ã‚‹ç’°å¢ƒå¤‰æ•°ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’Helmãƒãƒ£ãƒ¼ãƒˆã«å°å…¥ã™ã‚‹ã“ã¨ã§ã€å®Ÿç¾ã§ãã¾ã™ã€‚æ™‚é–“ãŒã‚ã‚‹éš›ã«ã§ã‚‚ã€ã“ã®Helmãƒãƒ£ãƒ¼ãƒˆã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

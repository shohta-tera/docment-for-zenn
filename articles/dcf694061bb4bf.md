---
title: "Kubernetesã«Apache Airflowã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹"
emoji: "ğŸ¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Kubernetes", "helm", "Airflow", "PostgreSQL"]
published: false
---

# ã¯ã˜ã‚ã«

# ç’°å¢ƒ
- WSL2: Ver20
- Helm: v3.6.1

## PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

- `database` namespaceã®ä½œæˆã€‚
```
kubectl create namespace database
```

- chartãƒ¬ãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
```
helm repo add bitnami https://charts.bitnami.com/bitnami
```

- install
```
helm upgrade --install postgresql bitnami/postgresql -n database
```

- ç¢ºèª

POSTGRESQLã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
``` 
export POSTGRES_PASSWORD=$(kubectl get secret --namespace database postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)
```
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
```
kubectl port-forward --namespace database svc/postgresql 5432:5432 &
    PGPASSWORD="$POSTGRES_PASSWORD" psql --host 127.0.0.1 -U postgres -d postgres -p 5432
```
Airflowç”¨ã®ãƒ­ãƒ¼ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®š
```
postgres=# CREATE DATABASE airflow;
postgres=# CREATE ROLE su_airflow WITH PASSWORD 'su_airflow';
postgres=# ALTER ROLE "su_airflow" WITH LOGIN;
postgres=# GRANT ALL PRIVILEGES ON DATABASE airflow TO su_airflow;
```

## MinIOã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### MinIOã®æ¦‚è¦

[MinIO](https://min.io/)ã¨ã¯ã€Amazon S3ã®APIã¨äº’æ›æ€§ã‚’ã‚‚ã£ãŸã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®OSSã§ã™ã€‚Airflowã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¯ã€ElasticSearchã‚„Amazon S3ã‚’ä½¿ã£ã¦ã€ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ãŒã€Helmã‚’ç”¨ã„ã¦Kubernetesãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒå†…ã§æ§‹ç¯‰ã—ã¦ã€ãŠé‡‘ã®ã‹ã‹ã‚‰ãšç°¡å˜ã«ãƒ­ã‚°ã‚’ä¿ç®¡ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

### MinIOã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

åŸºæœ¬çš„ã«ã¯ã€[å…¬å¼](https://github.com/minio/operator/tree/master/helm/minio-operator)ã®æ‰‹é †ã‚’ã‚‚ã¨ã«å®Ÿè¡Œã—ã¦ã„ãã¾ã™ã€‚

#### Helm repoã®ä½œæˆ

`helm repo add minio https://helm.min.io/`

#### Chartã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
kubectl create namespace minio
helm upgrade --install minio --namespace=minio --set persistence.size=1Gi,accessKey=AirflowTest,secretKey=asdqwe123 minio/minio --values=values.yaml
```

#### Port forward
```
export POD_NAME=$(kubectl get pods --namespace minio -l "release=minio" -o jsonpath="{.items[0].metadata.name}") && \
kubectl port-forward $POD_NAME 9000 --namespace minio
```

#### Airflowã®ãƒ­ã‚°ã®ãŸã‚ã®æº–å‚™

localhost:9000ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚  
![å³ä¸‹ã®æ–¹](https://storage.googleapis.com/zenn-user-upload/8a34c98f6cf4927c632dc0e2.png)
ä¸Šå›³ã®ã‚ˆã†ã«ã€Create BucketãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’é¸æŠã—ã¾ã™ã€‚  
åå‰ã¯ä»Šå›ã¯`airflow`ã¨ã—ã¦ã„ã¾ã™ã€‚
![ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼](https://storage.googleapis.com/zenn-user-upload/8801446f13ff44756c864ba4.png)
ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆã«å¯¾ã—ã¦ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚  
ä»Šå›ã¯ã™ã¹ã¦ã®Pathã«å¯¾ã—ã¦ã€`Read and Write`ã‚’è¨­å®šã™ã‚‹ã€‚  

## Airflow

### Airflowã«ã¤ã„ã¦

Pythonã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹DAG(æœ‰å‘éå·¡å›ã‚°ãƒ©ãƒ•)ã§ä½œæˆã—ãŸã‚¸ãƒ§ãƒ–ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  
è©³ã—ã„å†…å®¹ãªã©ã¯ã€DevelopersIOã®è¨˜äº‹ãªã©ãŒéå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã™ã®ã§ã€è¨˜è¼‰ã—ã¦ãŠãã€ä»Šå›ã¯æ¦‚è¦ã®èª¬æ˜ã¯ã—ã¾ã›ã‚“ã€‚
- https://dev.classmethod.jp/articles/airflow-gs-arch-learn/

ã¾ãŸã€ä»Šå›ä½¿ç”¨ã™ã‚‹Helm Chartã¯[å…¬å¼](https://github.com/airflow-helm/charts/tree/main/charts/airflow)ã®ã‚‚ã®ã§ã¯ãªãã€[Bitnami](https://github.com/bitnami/charts/tree/master/bitnami/airflow)ã«ã‚ˆã‚‹ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ç†ç”±ã¨ã—ã¦ã¯ã€å…¬å¼ã‚ˆã‚ŠBitnamiç‰ˆã®ã»ã†ãŒæ›´æ–°é »åº¦ãŒé«˜ã‹ã£ãŸãŸã‚ã§ã™ã€‚

### Airflowã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
./
â”œâ”€â”€ files
â”‚   â””â”€â”€ config
â”‚       â””â”€â”€ requirements.txt
â”œâ”€â”€ secrets
â”‚   â””â”€â”€ secrets.yaml
â””â”€â”€ values.yaml
```
secrets.yamlã«ã¯Airflowãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®èªè¨¼æƒ…å ±ã¨fernetKeyã‚’ã€gitã‹ã‚‰å–å¾—ã™ã‚‹èªè¨¼æƒ…å ±ã‚’è¨­å®šã™ã‚‹ã€‚

#### secrets.yaml

```
---
auth:
  username: su_airflow
  password: a1rfl0w@
  # python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
  fernetKey: uNJX4cU7e1HWupdeFOwoczu-q8f4jwl5rObZGk9F2jk=

git:
  dags:
    enabled: true
    repositories:
      - name: workflow
        repository: githubã®ãƒ¬ãƒã‚¸ãƒˆãƒªæƒ…å ±ã€‚ãƒ¬ãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚å…¥ã‚‹ã€‚
        branch: main
        path: src/dags
```

#### values.yaml

```
---

executor: KubernetesExecutor
redis:
  enabled: false
rbac:
  create: true
serviceaccount:
  create: true

postgresql:
  enabled: false
externalDatabase:
  host: postgresql-headless.database.svc.cluster.local
  user: su_airflow
  database: airflow
  port: 5432
extraEnvVars:
  - name: "AIRFLOW__API__AUTH_BACKEND"
    value: "airflow.api.auth.backend.basic_auth"
  - name: "AIRFLOW__WEBSERVER__EXPOSE_CONFIG"
    value: "True"
  - name: "AIRFLOW__CORE__LOAD_EXAMPLES"
    value: "False"
  - name: "GNICORN_CMD_ARGS"
    value: "--log-level WARNING"
  - name: "PYTHONPATH"
    value: "opt/bitnami/airflow/dags/git_workflow"
  - name: "AIRFLOW__LOGGING__REMOTE_LOGGING"
    value: "True"
  - name: "AIRFLOW__LOGGING__ENCRYPT_S3_LOGS"
    value: "False"
  - name: "AIRFLOW__LOGGING__REMOTE_BASE_LOG_FOLDER"
    value: "s3://airflow/logs"
  - name: "AIRFLOW__LOGGING__REMOTE_LOG_CONN_ID"
    value: "local_minio"

web:
  replicaCount: 1
  extraVolumeMounts:
    - name: airflow-python-requirements
      mountPath: /bitnami/python/
  extraVolumes:
    - name: airflow-python-requirements
      configMap:
        name: airflow-python-requirements

scheduler:
  replicaCount: 1
  extraVolumeMounts:
    - name: airflow-python-requirements
      mountPath: /bitnami/python/
  extraVolumes:
    - name: airflow-python-requirements
      configMap:
        name: airflow-python-requirements

worker:
  extraVolumeMounts:
    - name: airflow-python-requirements
      mountPath: /bitnami/python/
  extraVolumes:
    - name: airflow-python-requirements
      configMap:
        name: airflow-python-requirements

metrics:
  enabled: true
```
ä¸»ãªè¨­å®šé …ç›®ã¯ä»¥ä¸‹ã€‚
- executor: Kubernetesä¸Šã§å®Ÿè¡Œã™ã‚‹ãŒDAGå®Ÿè¡Œæ™‚ã«Podã‚’ä½œæˆã™ã‚‹`KubernetesExecutor`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
- postgresql: äº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸPostgreSQLã‚’ä½¿ç”¨ã™ã‚‹æƒ³å®šã§ã™ã€‚
- extraEnvVars: æœ€ä½é™å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ã¿ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

#### Namespaceã®ä½œæˆ

`kubectl creaate namespace jobs`

#### helm chartã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã“ã®ã‚³ãƒãƒ³ãƒ‰å†…ã§ã€PostgreSQLã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
```
helm upgrade airflow bitnami/airflow \
  --install \
  --namespace jobs \
  --values=./values.yaml \
  --values=./secrets/secrets.yaml \
  --set externalDatabase.password=su_airflow \
  --set web.image.tag=2.0.2-debian-10-r4 \
  --set scheduler.image.tag=2.0.2-debian-10-r13 \
  --set worker.image.tag=2.0.2-debian-10-r13 \
  --set metrics.image.tag=0.20210126.0-debian-10-r93 \
  --version 10.0.1
```

#### Port forwardã®è¨­å®š

`kubectl port-forward --namespace jobs svc/airflow 8080:8080`

localhost:8080ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä¸‹å›³ã®ã‚ˆã†ãªUIãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![TOP](https://storage.googleapis.com/zenn-user-upload/6cf1f513dd5b0885744244fe.png)

Adminã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®Connectionã‹ã‚‰ã€minioç”¨ã®æ¥ç¶šè¨­å®šã‚’ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/17cdb6cbcfb349774fb83eab.png)
ä¸Šå›³ã®ã‚ˆã†ã«ã€è¨­å®šã™ã‚‹ã€‚
æ¥ç¶šåã¯yamlã§è¨­å®šã—ãŸã‚‚ã®ã¨åŒä¸€ã®ã‚‚ã®ã‚’ç”¨ã„ã‚‹ã€‚  
ã¾ãŸã€Loginã¨Passwordã«ã¯Minioä½œæˆæ™‚ã«è¨­å®šã—ãŸAccessKeyã¨SecretAccessKeyã‚’ç”¨ã„ã¾ã™ã€‚ã•ã‚‰ã«Hostã«ã¯ã€minioã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯Airflowã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€åŸºæœ¬çš„ãªè¨­å®šã¾ã§ã«ã—ã¦ã„ã¾ã™ã€‚  
æ¬¡å›ä»¥é™ã¯DAGã®æ›¸ãæ–¹ãªã©ã«ã¤ã„ã¦ã‹ã‘ã‚Œã°ã¨æ€ã£ã¦ã„ã¾ã™ã€‚  

å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯[GitHub](https://github.com/shohta-tera/airflow)ã«ãŠã„ã¦ã„ã¾ã™ã€‚
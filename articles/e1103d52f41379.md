---
title: "AWS CDKã¨GitHub Actionsã‚’ç”¨ã„ã¦AWS App Runnerã‚’ä½¿ç”¨ã™ã‚‹"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "githubactions", "apprunner", "awscdk"]
published: true
---


# ã¯ã˜ã‚ã«

ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦æä¾›ã™ã‚‹æ–¹ã¯è¤‡æ•°ã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€S3ã«é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ã€CloudfrontçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãªã©ãŒã‚ã‚Šã¾ã™ã€‚  
æ˜¨å¹´ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸAWS App Runnerã¯ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã€ECRã«ã‚³ãƒ³ãƒ†ãƒŠã‚’Pushã™ã‚‹ã ã‘ã€ã‚‚ã—ãã¯GitHubã®ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’ç›´æ¥ã¤ãªã’ã‚‹ã ã‘ã§ã€AWSãŒæä¾›ã™ã‚‹LBã‚„VPCã‚’ä½¿ç”¨ã—ã¦ç°¡å˜ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã§ãã¾ã™ã€‚  

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç°¡å˜ã«æ§‹ç¯‰ã§ãã‚‹ã®ãŒã€AWS App Runnerã®ç‰¹å¾´ã§ã‚ã‚Šã€ã„ã„ã¨ã“ã‚ã ã¨æ€ã„ã¾ã™ã€‚ãŸã ã€é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«ãƒ†ã‚¹ãƒˆã‚’å›ã™ã ã¨ã‹ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã‹ã®æ¤œè¨¼ã‚’è¡ŒãŠã†ã¨æ€ã†ã¨ã€æ‰‹å‹•ã§æ§‹ç¯‰ã™ã‚‹ã®ã¯éç¾å®Ÿçš„ã§ã™ã€‚  
ãã“ã§ã€GitHub Actionsã¨AWS CDKã‚’çµ„ã¿åˆã‚ã›CICDã‚’è€ƒæ…®ã—ã¦AWS App Runnerã‚’ä½¿ç”¨ã™ã‚‹ã‚‚ã®ã‚’ä½œã£ã¦ã¿ãŸã®ã§ã€ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚  
ä»Šå›ç´¹ä»‹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
https://github.com/shohta-tera/AppRunnerWithCICD/tree/feature/test-commit

## ç’°å¢ƒ

- Node.js: v16.14.3
- Next.js: 12
- AWS CDK: 2.17.0

## ãƒ¬ãƒã‚¸ãƒˆãƒªæ§‹æˆ

ä»Šå›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ¢ãƒãƒ¬ãƒã§3ã¤ã®ãƒ‘ãƒ¼ãƒˆã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚
- `.github`: GitHub Actionsã®å®šç¾©ãŒå…¥ã£ãŸyaml
- `infrastructure`: AWS CDKã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
- `services/web-app`: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤

ä»Šå›ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯Next.jsã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

```
./
â”œâ”€â”€ .github
â”œâ”€â”€ infrastructure
â”‚   â”œâ”€â”€ bin
â”‚   â”œâ”€â”€ lib
â””â”€â”€ services
    â””â”€â”€ web-app
```

## GitHub Actions

GitHub Actionsã¯ä¸»ã«2ã¤ã«åˆ†ã‘ã¦ã„ã¾ã™ã€‚
- ECRã®ãƒ‡ãƒ—ãƒ­ã‚¤
- ã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã€ãƒ“ãƒ«ãƒ‰ãŠã‚ˆã³App Runnerã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

### GitHub OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ç”¨ã„ãŸAWS CDKã®å®Ÿè¡Œ

ä»Šå›AWSã¸ã®ãƒªã‚½ãƒ¼ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã‚ãŸã‚Šã€GitHub OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ç”¨ã„ã¦ã¾ã™ã€‚ã“ã‚Œã¯ã€CICDç”¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚‹ã“ã¨ã§ã€AWSã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æƒ…å ±ã‚’GitHubã§ç®¡ç†ã—ãŸããªã„ãŸã‚ã§ã™ã€‚  
GitHub ActionsãŒassume roleã™ã‚‹IAMãƒ­ãƒ¼ãƒ«ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯[å…¬å¼](https://github.com/aws-actions/configure-aws-credentials)ã‚’å‚è€ƒã«è¨˜è¼‰ã—ã¾ã™ã€‚

```
Parameters:
  GitHubOrg:
    Type: String
  RepositoryName:
    Type: String
  OIDCProviderArn:
    Description: Arn for the GitHub OIDC Provider.
    Default: ""
    Type: String

Conditions:
  CreateOIDCProvider: !Equals 
    - !Ref OIDCProviderArn
    - ""

Resources:
  Role:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns: [arn:aws:iam::aws:policy/AdministratorAccess]
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !If 
                - CreateOIDCProvider
                - !Ref GithubOidc
                - !Ref OIDCProviderArn
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/${RepositoryName}:*

  GithubOidc:
    Type: AWS::IAM::OIDCProvider
    Condition: CreateOIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList: 
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1

Outputs:
  Role:
    Value: !GetAtt Role.Arn 
```
å…¬å¼ã‹ã‚‰ã¯ã€ManagedPolicyArnsã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã§ã¯ã€`AdministratorAccess`ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚  
AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Cloudformationã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã¯ã€ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚  
- GitHubOrg: Organizationã®åå‰ã€‚å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€‚
- RepositoryName: å¯¾è±¡ã®ãƒ¬ãƒã‚¸ãƒˆãƒªå
- OIDCProviderArn: ç©ºç™½ã§ã‚‚å¯èƒ½ã€‚

ä¸Šè¨˜ã‚’äº‹å‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸä¸Šã§ã€ç”Ÿæˆã•ã‚Œã‚‹IAMãƒ­ãƒ¼ãƒ«ã‚’GitHubã®ãƒ¬ãƒã‚¸ãƒˆãƒªã®Secretsã«æ ¼ç´ã—ã¾ã™ã€‚ä»Šå›ã®ä¾‹ã§ã¯ã€`AWS_ROLE`ã¨ã—ã¦ã„ã¾ã™ã€‚

### ECRã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã®GitHub Actionsã§ã¯ã€ECRã®ãƒ‡ãƒ—ãƒ­ã‚¤ã ã‘ã§ãªãã€AWS CDKã®Bootstrapã‚‚å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚  
ãã®ãŸã‚ã€ã“ã®Actionsã¯åˆå›ã«å®Ÿè¡Œã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::details GitHub Actionsã®å…¨ä½“
```
name: Create base infrastructure

on:
  push:
    paths:
      - "infrastructure/lib/*"
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  create_resource:
    runs-on: ubuntu-20.04
    env:
      working-directory: ./infrastructure
      AWS_ROLE_ARN: ${{secrets.AWS_ROLE}}
      AWS_REGION: ap-northeast-1
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: "16.x"
          cache: "yarn"
          cache-dependency-path: ${{env.working-directory}}/yarn.lock
      - name: Setup dependencies
        run: yarn install
        working-directory:  ${{env.working-directory}}
      - name: Setup environment variables
        run: echo "REPO_NAME=${GITHUB_REPOSITORY#*\/}" >> $GITHUB_ENV
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{env.AWS_REGION}}
          role-to-assume: ${{env.AWS_ROLE_ARN}}
          role-session-name: ${{env.REPO_NAME}}-github-action
      - name: Build
        run: yarn build
        working-directory:  ${{env.working-directory}}
      - name: Bootstrap
        run: yarn cdk:bootstrap
        working-directory:  ${{env.working-directory}}
      - name: CDK diff check for ECR
        run: yarn cdk:diff ContainerRegistryStack
        working-directory:  ${{env.working-directory}}
      - name: Deploy ECR
        run: yarn cdk:deploy ContainerRegistryStack
        working-directory:  ${{env.working-directory}}
```
:::

### ã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã€Lintã€ãƒ“ãƒ«ãƒ‰ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®pushãŠã‚ˆã³ã€App Runnerã®ãƒ‡ãƒ—ãƒ­ã‚¤

ä½œæˆã—ãŸActionsã¨ã—ã¦ã¯ã€`main`,`develop`ã«ã‚³ãƒ¼ãƒ‰ãŒpushã•ã‚ŒãŸã¨ãã¨ã€`develop`ã«å¯¾ã™ã‚‹PRãŒä½œæˆã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ç’°å¢ƒã¨ã—ã¦ã¯ã€prod, stage, devã®3ç’°å¢ƒã‚’ä½œæˆã™ã‚‹å‰æã§ã™ã€‚prodãŒ`main`ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã€stageãŒ`develop`ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã€devãŒPRã§ä½œæˆã•ã‚Œã‚‹å„PRã®çµæœã‚’ç¢ºèªã™ã‚‹ç’°å¢ƒã¨ã—ã¦ã„ã¾ã™ã€‚ Actionsã§ã¯ã€å®Ÿè¡Œã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆ(PRãªã©)ã‚„ã€å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒãªã©ãŒå¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¦ãŠã‚Šä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ä¸Šè¨˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚„å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¿ã‚°ã‚’ä½œã‚Šå¤‰ãˆãŸã‚Šã€AWS CDKã§ä½œæˆã•ã‚Œã‚‹AWSãƒªã‚½ãƒ¼ã‚¹ã®ä½œã‚Šåˆ†ã‘ã‚’è¡Œã£ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚  
å„PRã”ã¨ã«Actionsã‚’å‹•ä½œã•ã›ã‚‹ã“ã¨ã§ã€ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‰ãªã„é™ã‚Šdevelopã«ãƒãƒ¼ã‚¸ã§ããªã„ã¨ã„ã†ã‚ˆã†ãªåˆ¶ç´„ã‚’èª²ã™ã“ã¨ãŒã§ãã¾ã™ã€‚  
ã“ã®Actionsã¯æ¬¡ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã«ãªã£ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart LR
    A[lint and test code] & B[Build and push container] --> C(Deploy frontend)
```
Linterã«ã¯ã€ESLintã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ãªActionsã¨ã—ã¦ã¯ã€ESLint with review dogã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
https://github.com/reviewdog/action-eslint  
ã¾ãŸã€frontendã®ãƒ†ã‚¹ãƒˆã«ã¯jestã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ãŒã€PRã«CoverageReportã‚‚å‡ºã—ãŸã„ã®ã§ã€ä»¥ä¸‹ã®Actionsã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚  
https://github.com/ArtiomTr/jest-coverage-report-action  

ãƒ“ãƒ«ãƒ‰ã¯ã€Dockerfileã‚’å…ƒã«ãƒ“ãƒ«ãƒ‰ã‚’ã—ã€ãã®å¾Œã€`Trivy`ã¨`Dockle`ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’çµŒãŸä¸Šã§ã€ECRã«pushã•ã‚Œã¾ã™ã€‚  
`Trivy`ã§CVEãªã©ã®è„†å¼±æ€§DBã‚’å…ƒã«ã‚³ãƒ³ãƒ†ãƒŠã®OSã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾å­˜æ€§ã«ã¤ã„ã¦ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã€`Dockle`ã§Dockerfileã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å‰‡ã£ã¦ã„ã‚‹ã‹ã€CISãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã‚ˆã‚‹ãƒã‚§ãƒƒã‚¯ã‚’ã‹ã‘ã¦ã„ã¾ã™ã€‚`Trivy`ã¨`Dockle`ã¯ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹å¯¾è±¡ã‚„æ‰‹æ³•ãŒå®Œå…¨ã«ç•°ãªã‚‹ã®ã§ã€ä¸¡è€…ã‚’ä½µç”¨ã—ã¦ã„ã¾ã™ã€‚  

:::details Actionsã®å…¨ä½“åƒ
```
name: Execute test and deploy application

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - develop
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-20.04
    env:
      working-directory: ./services/web-app
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: "16.x"
          cache: "yarn"
          cache-dependency-path: ${{env.working-directory}}/yarn.lock
      - name: Setup dependencies
        run: yarn install
        working-directory:  ${{env.working-directory}}
      - name: Eslint with review-dog
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{secrets.github_token}}
          reporter: github-pr-review
          workdir: ${{env.working-directory}}
      # - name: Coverage report with jest-coverage-report-action
      #   uses: ArtiomTr/jest-coverage-report-action@v2
      #   if: contains(github.event_name, 'pull_request')
      #   with:
      #     github-token: ${{secrets.GITHUB_TOKEN}}
      #     package-manager: yarn
      #     test-script: yarn jest
      #     working-directory:  ${{env.working-directory}}

  build-test-and-push:
    runs-on: ubuntu-20.04
    env:
      working-directory: ./services/web-app
      AWS_ROLE_ARN: ${{secrets.AWS_ROLE}}
      AWS_REGION: ap-northeast-1
      ECR_REPOSITORY: ${{secrets.AWS_ECR_REPO_NAME}}
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: "16.x"
          cache: "yarn"
          cache-dependency-path: ${{env.working-directory}}/yarn.lock
      - name: Setup dependencies
        run: yarn install
        working-directory:  ${{env.working-directory}}
      - name: Setup environment variables
        run: echo "REPO_NAME=${GITHUB_REPOSITORY#*\/}" >> $GITHUB_ENV
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{env.AWS_REGION}}
          role-to-assume: ${{env.AWS_ROLE_ARN}}
          role-session-name: ${{env.REPO_NAME}}-github-action
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - name: Create Image tag
        run: |
          if [ "${{github.event_name}}" == "push" -a "${{github.ref}}" == "refs/heads/main" ]; then
            TAG=prod
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          elif [ "${{github.event_name}}" == "push" -a "${{github.ref}}" == "refs/heads/develop" ]; then
            TAG=stage
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          else
            TAG=$(echo ${{github.head_ref}} | sed -e "s#feature/##g" -e "s#bugfix/##g" -e "s#hotfix/##g" -e "/dependabot/s/.*/dependabot/")
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          fi
      - name: Build and tag container image
        working-directory:  ${{env.working-directory}}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry}}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --build-arg AWS_REGION="$AWS_REGION" .
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ steps.login-ecr.outputs.registry }}/${{env.ECR_REPOSITORY}}:${{env.IMAGE_TAG}}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os, library"
          severity: "CRITICAL"
      - name: Run Dockle vulunerbility scanner
        uses: hands-lab/dockle-action@v1
        with:
          image: "${{ steps.login-ecr.outputs.registry }}/${{env.ECR_REPOSITORY}}:${{env.IMAGE_TAG}}"
          exit-code: "1"
          exit-level: WARN
      - name: Push container image to Amazon ECR
        working-directory:  ${{env.working-directory}}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry}}
        run: docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  deploy:
    runs-on: ubuntu-20.04
    needs: [test, build-test-and-push]
    env:
      working-directory: ./infrastructure
      AWS_ROLE_ARN: ${{secrets.AWS_ROLE}}
      AWS_REGION: ap-northeast-1
      ECR_REPOSITORY: ${{secrets.AWS_ECR_REPO_NAME}}
      ENV: ${{github.event_name == 'push' && github.ref == 'refs/heads/main' && 'prod' || github.event_name == 'push' && github.ref == 'refs/heads/develop' && 'stage' || 'dev'}}
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: "16.x"
          cache: "yarn"
          cache-dependency-path: ${{env.working-directory}}/yarn.lock
      - name: Setup dependencies
        run: yarn install
        working-directory:  ${{env.working-directory}}
      - name: Setup environment variables
        run: echo "REPO_NAME=${GITHUB_REPOSITORY#*\/}" >> $GITHUB_ENV
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{env.AWS_REGION}}
          role-to-assume: ${{env.AWS_ROLE_ARN}}
          role-session-name: ${{env.REPO_NAME}}-github-action
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - name: Create Image tag
        run: |
          if [ "${{github.event_name}}" == "push" -a "${{github.ref}}" == "refs/heads/main" ]; then
            TAG=prod
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          elif [ "${{github.event_name}}" == "push" -a "${{github.ref}}" == "refs/heads/develop" ]; then
            TAG=stage
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          else
            TAG=$(echo ${{github.head_ref}} | sed -e "s#feature/##g" -e "s#bugfix/##g" -e "s#hotfix/##g" -e "/dependabot/s/.*/dependabot/")
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          fi
      - name: Build
        run: yarn build
        working-directory: ${{env.working-directory}}
      - run: sleep 300
      - name: CDK diff check for infra stack
        working-directory: ${{env.working-directory}}
        run: |
          APPLICATION_ENV=${{env.ENV}} yarn cdk:diff ${{env.ENV}}-InfrastructureStack
      - name: Deploy infra stack
        working-directory: ${{env.working-directory}}
        run: |
          APPLICATION_ENV=${{env.ENV}} yarn cdk:deploy ${{env.ENV}}-InfrastructureStack
      - name: CDK diff check for Frontend
        working-directory: ${{env.working-directory}}
        run: |
          APPLICATION_ENV=${{env.ENV}} yarn cdk:diff ${{env.ENV}}-FrontendStack
      - name: Deploy Frontend stack
        working-directory: ${{env.working-directory}}
        run: |
          IMAGE_TAG=${{env.IMAGE_TAG}} APPLICATION_ENV=${{env.ENV}} yarn cdk:deploy ${{env.ENV}}-FrontendStack
        env:
          ECR_REGISTRY: ${{steps.login-ecr.outputs.registry}}
```
:::

## AWS CDK

### ECR

åŸºæœ¬çš„ã«ã¯ECRã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒ¡ã‚¤ãƒ³ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–ã§ç’°å¢ƒã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹éš›ã«ã¯ã€`ReplicationPolicy`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®Replicationã‚’ã—ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’ä½œã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚  
:::details AWS CDKã§ECRéƒ¨åˆ†ã®ã¿
```
import { CfnReplicationConfiguration, Repository } from 'aws-cdk-lib/aws-ecr'
import { ParameterTier, StringParameter } from 'aws-cdk-lib/aws-ssm';
import * as cdk from 'aws-cdk-lib'

export class ContainerRegistryStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props)
    const accountId = cdk.Stack.of(this).account

    const repository = new Repository(this, 'testRepository', {
      repositoryName: 'west/test-frontend',
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      imageScanOnPush: true
    })
    const replicationRuleProperty: CfnReplicationConfiguration.ReplicationRuleProperty = {
      destinations: [
        {
          region: 'eu-west-1',
          registryId: accountId
        }
      ]
    }
    new CfnReplicationConfiguration(this, 'ReplicationPolicy', {
      replicationConfiguration: {
        rules: [replicationRuleProperty]
      }
    })
    new StringParameter(this, 'RepositoryParatmeter', {
      description: 'Repo name for frontend',
      parameterName: '/west/ECRRepositoryName',
      stringValue: repository.repositoryUri,
      tier: ParameterTier.STANDARD
    })
  }
}
```
:::

### IAM Role

ä»Šå›ä½œæˆã®ã‚‚ã®ã§ã¯ã€App RunnerãŒãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ECRã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®IAM Roleã¨ã€App Runnerã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãã®ã‚‚ã®ãŒä½¿ç”¨ã™ã‚‹IAM Roleã®2ç¨®é¡ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚  
å¾Œè€…ã®ã‚‚ã®ã¯ã€ç¾æ™‚ç‚¹ã§ã¯åŸºæœ¬çš„ãªã‚‚ã®ã—ã‹ç”¨æ„ã—ã¦ã„ã¾ã›ã‚“ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦`Dynamo DB`ã ã£ãŸã‚Šã€`Aurora serverless`ã®`Data API`ã‚’çµŒç”±ã—ãŸã‚¯ã‚¨ãƒªå®Ÿè¡Œãªã©ä»–ã®AWSãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«éƒ½åº¦è¿½åŠ ã•ã‚Œã‚‹ã‚‚ã®ã§ã™ãƒ»

:::details AWS CDKã®IAM Roleéƒ¨åˆ†
```
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as iam from 'aws-cdk-lib/aws-iam'

export class InfrastructureStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const accountId = cdk.Stack.of(this).account
    const region = cdk.Stack.of(this).region
    const systemEnv = process.env.APPLICATION_ENV ?? 'dev'

    new iam.Role(this, 'ServiceRoleForAppRunner', {
      roleName: `${systemEnv}-AppRunnerECRAccessRole`,
      assumedBy: new iam.CompositePrincipal(new iam.ServicePrincipal('build.apprunner.amazonaws.com')),
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSAppRunnerServicePolicyForECRAccess')
      ],
      path: '/service-role/'
    })

    new iam.Role(this, 'ServiceRoleForApplication', {
      roleName: `${systemEnv}-AppRunnerRole`,
      assumedBy: new iam.CompositePrincipal(new iam.ServicePrincipal('tasks.apprunner.amazonaws.com')),
      inlinePolicies: {
        inlinePolicies: iam.PolicyDocument.fromJson({
          Version: '2012-10-17',
          Statement: [
            {
              Effect: 'Allow',
              Action: ['ssm:GetParameter*'],
              Resource: `arn:aws:ssm:${region}:${accountId}:parameter/*`
            },
            {
              Effect: 'Allow',
              Action: ['kms:Decrypt'],
              Resource: `arn:aws:kms:${region}:${accountId}:key/*`
            }
          ]
        })
      }
    })
  }
}
```
:::

### AWS App Runner

ä»Šå›ã®ä½œæˆã®ã‚‚ã®ã§ã¯ã€App Runnerã¯L1ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚å½“åˆã¯L1ã—ã‹ãªã‹ã£ãŸã®ã§ã™ãŒã€L2ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ãŸã ã€App Runnerã¯åŸºæœ¬çš„ã«ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆè¦ç´ ãŒå°‘ãªãè¨­å®šã‚‚å°‘ãªã„ã®ã§ã€L1ã§è¨˜è¼‰ãŒã—ã‚“ã©ã„è¨³ã§ã¯ãªã„ã§ã™ã€‚  

:::details AWS CDKã®App Runneréƒ¨åˆ†
```
import * as apprunner from 'aws-cdk-lib/aws-apprunner'
import * as cdk from 'aws-cdk-lib'

export class ApplicationStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props)
    const systemEnv = process.env.APPLICATION_ENV ?? 'dev'
    const imageTag = process.env.IMAGE_TAG ?? '1.0.0'
    const serviceName = `${systemEnv}-test-frontend`

    const accountId = cdk.Stack.of(this).account
    // const region = cdk.Stack.of(this).region

    const envList = [
      { name: 'PORT', value: '3000' }
    ]
    const registryName = process.env.ECR_REGISTRY ?? ''
    const repositoryName = `${registryName}/west/test-frontend`

    new apprunner.CfnService(this, 'test-application', {
      sourceConfiguration: {
        authenticationConfiguration: {
          accessRoleArn: `arn:aws:iam::${accountId}:role/service-role/${systemEnv}-AppRunnerECRAccessRole`
        },
        autoDeploymentsEnabled: true,
        imageRepository: {
          imageIdentifier: `${repositoryName}:${imageTag}`,
          imageRepositoryType: 'ECR',
          imageConfiguration: {
            port: '3000',
            runtimeEnvironmentVariables: envList
          }
        }
      },
      instanceConfiguration: {
        cpu: '1024',
        memory: '2048',
        instanceRoleArn: `arn:aws:iam::${accountId}:role/${systemEnv}-AppRunnerRole`
      },
      serviceName: serviceName
    })
  }
}
```
:::

## Frontend

ä»Šå›ã§ã¯ã€`npx create-next-app@latest`ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚ŒãŸNext.jsã®Welcomeãƒšãƒ¼ã‚¸ã‚’ãã®ã¾ã¾ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™ã€‚  
ã¾ãŸã€App RunnerãŒä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
https://zenn.dev/kazumax4395/articles/427cc791f6145b

åŸºæœ¬çš„ã«ã¯ã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¤ã¤ã€distrolessã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§Attack surfaceã‚’æœ€å°åŒ–ã—ã€æœ€æ–°ã®æ›´æ–°ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹æ–¹é‡ã§ã™ã€‚

:::details Dockerfile
```
# Base layer
FROM node:16-slim AS base
WORKDIR /app

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile --newtwork-timeout 600000
COPY . .

# Package install Layer
FROM node:16-slim AS node_modules

WORKDIR /modules

COPY package.json yarn.lock ./
RUN yarn install --non-interactive --frozen-lockfile --production --newtwork-timeout 600000

# Build layer
FROM base AS build
ENV NODE_ENV=production
WORKDIR /build

COPY --from=base /app ./
RUN yarn build

# Production run layer
FROM gcr.io/distroless/nodejs:16
ENV NODE_ENV=production
WORKDIR /app

COPY package.json yarn.lock next.config.js ./
COPY --from=build /build/public ./public
COPY --from=build /build/.next ./.next
COPY --from=node_modules /modules/node_modules ./node_modules

EXPOSE 3000

CMD ["node_modules/.bin/next", "start"]
```
:::
:::details .dockerignore
```
.next
node_modules
__test__
```
:::

## ãŠã‚ã‚Šã«

App Runnerã¯ã€è¨­å®šäº‹é …ã‚‚å°‘ãªãã€AWSã®å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚‚å°‘ãªã„ã®ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ç’°å¢ƒã¨ã—ã¦ã¯æœ€é©ã ã¨æ€ã„ã¾ã™ã€‚App Runnerã‚’ç”¨ã„ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ¤œè¨ã•ã‚Œã‚‹æ–¹ã«å‚è€ƒã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚  
ã¾ã ã¾ã ã€GitHub Actionsã‚„AWS CDKã‚’è§¦ã‚Šå§‹ã‚ãŸã¨ã“ã‚ã§ã‚ã‚‹ã®ã§ã€ç†è§£ãŒé–“é•ã£ã¦ã‚‹ç‚¹ã‚„ã”åŠ©è¨€ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã€ãœã²ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„!  
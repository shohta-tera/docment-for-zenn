---
title: "k6-operatorã‚’åˆ©ç”¨ã—ãŸk8sä¸Šã§ã®è² è·ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["k6", "Grafana", "Kubernetes"]
published: false
---

## ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯å‰å›ç´¹ä»‹ã—ãŸk6ã‚’Kuberneteså†…ã§å®Ÿè¡Œã™ã‚‹è¨˜äº‹ã®ç¶šãã§ã™ã€‚
https://zenn.dev/shorter/articles/8ba0bf62afa03a

ä¸Šè¨˜ã®è¨˜äº‹ã§ã¯ã€k6ã‚’è‡ªå‰ã§ãƒ“ãƒ«ãƒ‰ã—ã¦Jobã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã—ãŸã€‚
ãŸã ã€ä¸Šè¨˜ã®å ´åˆã ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¤‰æ›´ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ãƒã‚¸ãƒˆãƒªã«Pushã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
ä»Šå›ç´¹ä»‹ã™ã‚‹k6-operatorã‚’åˆ©ç”¨ã™ã‚Œã°ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹k6ã®å®Ÿè¡Œç’°å¢ƒã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚ã‘ã‚‹ã“ã¨ãŒã§ãã€ã‚ˆã‚Šä½¿ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚

## ç’°å¢ƒ

* Docker Desktop for mac: v4.27.1
* Kubernetes: k3d

## k6-operatorã«ã¤ã„ã¦

k6-operatorã¯Kubernetes Operatorã®ä¸€ã¤ã§ã€è² è·ãƒ†ã‚¹ãƒˆå®šç¾©ã‚’Custom Resourceã¨ã—ã¦Apllyã™ã‚‹ã¨ã€ã“ã®Operator ControllerãŒå¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚å¿…è¦ãŒã‚ã‚Œã°ã€k6ãƒ†ã‚¹ãƒˆã®ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã—ã¾ã™ã€‚

![](https://grafana.com/media/blog/k6/images/pattern.png)
å¼•ç”¨å…ƒ: https://grafana.com/blog/2022/06/23/running-distributed-load-tests-on-kubernetes/

### k6-operatorã®ãƒ‡ãƒ—ãƒ­ã‚¤

k6-operatorã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯helm chartã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm upgrade k6-operator grafana/k6-operator \
  --install \
  --namespace k6-operator \
  --create-namespace
```

## k6ã®å®Ÿè¡Œ

### 1å›ãã‚Šã®å®Ÿè¡Œ

ãƒ†ã‚¹ãƒˆå®šç¾©ã‚’Custom Resourceã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚
ä»Šå›k6ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Archiveã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€tarãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ãŸä¸Šã§ConfigMapã¨ã—ã¦ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
ã“ã®k6ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã£ã¦ã€åˆ©ç”¨ã™ã‚‹ãŸã‚ã§ã™ã€‚

```
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-test
  namespace: k6-operator-system
spec:
  parallelism: 1
  script:
    configMap:
      name: "k6-script-binary"
      file: "k6-script.tar"
  runner:
    env:
      - name: RAMP_UP_DURATION
        value: '1m'
      - name: RAMP_UP_TARGET
        value: '3'
      - name: STEADY_STATE_DURATION
        value: '60m'
      - name: STEADY_STATE_TARGET
        value: '3'
      - name: RAMP_DOWN_DURATION
        value: '30s'
      - name: RAMP_DOWN_TARGET
        value: '0'
    envFrom:
      - configMapRef:
          name: k6-operator-configmap
      - secretRef:
          name: k6-test-secrets
  arguments:
    # Write metrics to the prometheus
    -o experimental-prometheus-rw
```

ä¸»ãªè¨­å®šé …ç›®
- `spec.runner.env`: ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ™‚é–“ãªã©ã‚’ã“ã“ã§å®šç¾©ã—ã€k6ã®å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã“ã‚Œã‚‰ã®å€¤ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã§ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚
- `spec.runner.envFrom`: Prometheusã®æ¥ç¶šå…ˆãªã©å›ºå®šã—ãŸç’°å¢ƒå¤‰æ•°ãªã©ã‚ã‚Œã°ã€ConfigMap, Secretã¨ã—ã¦ç™»éŒ²ã—å‹•çš„ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
- arguments: k6ã‚’å®Ÿè¡Œã™ã‚‹ä¸Šã§ã®å¼•æ•°ã§ã™ã€‚ã“ã“ã®ä¾‹ã§ã¯Prometheusã¸çµæœã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦æ›¸ãå‡ºã™ãŸã‚ã®è¨­å®šã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¯ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã ã‘ã§ã™ã€‚
```
kubectl apply -f ./custom-resource.yaml
```

ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã‚‚ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ãªã‘ã‚Œã°ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã¯æ®‹ã£ãŸã¾ã¾ã§ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
æ¬¡å›å®Ÿè¡Œæ™‚ã«ã“ã®ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹ã¨ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒã•ã‚Œãªã„ã®ã§ã€çµ‚äº†å¾Œã¯ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
```
kubectl delete -f ./custom-resource.yaml
```

### å®šæœŸçš„ãªå®Ÿè¡Œ

ä¸Šè¨˜ã®ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹å®šç¾©ã‚’ConfigMapã¨ã—ã¦ç™»éŒ²ã—ã¦ãŠãã€CronJobã§ä½œæˆã¨å‰Šé™¤ã‚’ã™ã‚‹ã“ã¨ã§å®šæœŸçš„ãªå®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚

å‰ææ¡ä»¶: ä¸Šè¨˜ã®ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’k6-testã¨ã„ã†ConfigMapã«test.yamlã¨ã—ã¦ç™»éŒ²ã—ã¦ã„ã‚‹ã€‚

```
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k6-load-testing-cron-job
spec:
  schedule: "0 */3 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccount: k6
          containers:
            - name: kubectl
              image: bitnami/kubectl
              volumeMounts:
                - name: k6-yaml
                  mountPath: /tmp/
              command:
                - /bin/bash
              args:
                - -c
                - "kubectl delete -f /tmp/test.yaml; kubectl apply -f /tmp/test.yaml"
          restartPolicy: OnFailure
          volumes:
            - name: k6-yaml
              configMap:
                name: k6-test
```

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Extensionä»¥å¤–ã‚’åˆ©ç”¨ã—ãŸã„å ´åˆ

å‰å›ã®è¨˜äº‹ã§ã¯ã€`xk6-output-prometheus-remote`ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ†ã‚¹ãƒˆçµæœã‚’`Prometheus`ã«é€ä¿¡ã—ã¦ã„ã¾ã—ãŸã€‚
k6 v0.42.0ã‹ã‚‰ã“ã®æ‹¡å¼µæ©Ÿèƒ½ãŒExperimental moduleã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ãã®ãŸã‚ã€ã‚ã–ã‚ã–è‡ªå‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã—ãŸã€‚
ãŸã ã—ã€ãã®ä»–ã®æ‹¡å¼µæ©Ÿèƒ½ã¯å¼•ãç¶šããƒ“ãƒ«ãƒ‰ã—ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«Pushã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```
# Build the k6 binary with the extension
FROM golang:1.20 as builder

RUN go install go.k6.io/xk6/cmd/xk6@latest
# For our example, we'll add support for output of test metrics to InfluxDB v2.
# Feel free to add other extensions using the '--with ...'.
RUN xk6 build \
    --with github.com/grafana/xk6-output-influxdb@latest \
    --output /k6

# Use the operator's base image and override the k6 binary
FROM grafana/k6:latest
COPY --from=builder /k6 /usr/bin/k6
```

ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã«ã¦ã€ã“ã†ã—ã¦ãƒ“ãƒ«ãƒ‰ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«è¨˜è¼‰ã™ã‚Œã°ã€æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-sample-with-extensions
spec:
  parallelism: 4
  script:
    configMap:
      name: crocodile-stress-test
      file: test.js
  runner:
    image: k6-extended:local
    env:
      - name: K6_OUT
        value: xk6-influxdb=http://influxdb.somewhere:8086/demo
```
å¼•ç”¨: https://github.com/grafana/k6-operator?tab=readme-ov-file#using-extensions


## çµæœç¢ºèª

ã‚‚ã¡ã‚ã‚“ã€ãƒ†ã‚¹ãƒˆçµæœã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦Prometheusã«ç™»éŒ²ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆçµæœã¯Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
https://grafana.com/grafana/dashboards/18030-k6-prometheus-native-histograms/


## ãŠã‚ã‚Šã«

k6ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®PCã§å®Ÿè¡Œã™ã‚‹ã¨ã€PCã®ä»–ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®å½±éŸ¿ã‚„è‡ªå®…ã‚ªãƒ•ã‚£ã‚¹ãªã©ã®é€šä¿¡é€Ÿåº¦ã®å½±éŸ¿ã‚’å—ã‘ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ã‚µãƒ¼ãƒ“ã‚¹ã®æ€§èƒ½è©¦é¨“ãªã©æ­£ç¢ºã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ããªã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
ã“ã†ã—ã¦k6-operatorã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’è¨˜è¼‰ã—ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã ã‘ã§k6è‡ªä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚„ãƒ†ã‚¹ãƒˆçµæœã‚’Prometheusã«é€ã‚‹ãªã©ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚ãã®ãŸã‚é–‹ç™ºè€…ãŒãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã‚„å®Ÿè¡Œã™ã‚‹ã“ã¨ã«å¯¾ã—ã¦ã®æŠµæŠ—æ„ŸãŒãªããªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
---
title: "Postgresqlã®Multiple Primariesã‚’æ¤œçŸ¥ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã™ã‚‹"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["postgresql", "kubernetes", "prometheus", "grafana"]
published: true
---

### ã¯ã˜ã‚ã«

Postgresqlã‚’Kubernetesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ä¸€ã¤ã‚„ã£ã‹ã„ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯ã€è¤‡æ•°ãƒ¬ãƒ—ãƒªã‚«å­˜åœ¨ã™ã‚‹Postgresqlã«ãŠã„ã¦ã€é€šå¸¸ã§ã¯PostgresqlãŒä½•ã‚‰ã‹ã®ä¸å…·åˆã§Kubernetesã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ãŸã¨ãã«ã€Primaryã®ãƒãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‹ã‚‰åˆ‡ã‚Šé›¢ã•ã‚Œã€ã‚¹ã‚¿ãƒ³ãƒã‚¤ã®ãƒãƒ¼ãƒ‰ãŒãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã«æ˜‡æ ¼ã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãŒæ­£ã—ãå‹•ã‹ãšã€è¤‡æ•°ã®PrimaryãŒã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã«å­˜åœ¨ã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒå–ã‚Œãªã‹ã£ãŸã‚Šã™ã‚‹åŸå› ã«ãªã‚Šã¾ã™ã€‚  
ã“ã‚Œã¯ã€ä½¿ç”¨ã—ã¦ã„ã‚‹Postgresqlã®Helmãƒãƒ£ãƒ¼ãƒˆã®ãƒ¬ãƒã‚¸ãƒˆãƒªã§ã‚‚è¤‡æ•°å›å•é¡ŒãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ãŒã€ç¾åœ¨ã§ã‚‚ä¿®æ­£ã•ã‚Œã¦ã¯ã„ã¾ã›ã‚“ã€‚
https://github.com/bitnami/charts/issues/2610
https://github.com/bitnami/charts/issues/5589
https://github.com/bitnami/charts/issues/12263

ä¸Šè¨˜å•é¡Œã®å¯¾å‡¦æ³•ã¨ã—ã¦ã¯ã€æœ¬æ¥ã‚¹ã‚¿ãƒ³ãƒã‚¤ã§ã‚ã‚‹ã¯ãšãŒPrimaryã¨ã—ã¦å‹•ä½œã—ã¦ã„ã‚‹Podã‚’å‰Šé™¤ã™ã‚‹ã€‚ã¨ã„ã†ã®ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ãŒã€ã—ã‹ã—ã“ã®ç¾è±¡ãŒã„ã¤èµ·ã“ã‚‹ã®ã‹ã¯ä¸æ˜ã®ãŸã‚ã€Prometheusã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãªã©ã‚’åˆ©ç”¨ã—ã¦ç™ºç”Ÿã—ãŸæ®µéšã§ã‚ã‹ã‚‹ã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆãŒå¿…è¦ã«ãªã£ã¦ãã¾ã™ã€‚ä»Šå›ãã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆã—ãŸã®ã§ã€ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
å…¨ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ãƒ¬ãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚
https://github.com/shohta-tera/postgres-with-dashboard

### ç’°å¢ƒ
- WSL2: Ubuntu 20.04
- Docker: 4.10.1
- kind: kind v0.11.1 go1.16.4 linux/amd64

### Postgresqlã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Postgresqlã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯Helmãƒãƒ£ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
https://github.com/bitnami/charts/tree/master/bitnami/postgresql-ha

ãƒ­ãƒ¼ã‚«ãƒ«ã®Kindã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«å¿…è¦ãªè¨­å®šã‚’values.yamlã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

```yaml values.yaml
---
global:
  storageClass: 'local-path'
  postgresql:
    postgresqlPassword: postgres
postgresql:
  priorityClassName: ''
  username: test
  password: test
  repmgrUsername: repmgr
  repmgrPassword: repmgr!
  repmgrDatabase: repmgr

pgpool:
  adminUsername: admin
  adminPassword: admin
  configuration: |
    failover_on_backend_error = 'on'
    failover_command = '/opt/bitnami/pgpool/etc/failover.sh %d %P %H %R'
volumePermissions:
  enabled: true

metrics:
  enabled: true
  customMetrics:
  pg_replication:
    master: true
    query: |
      SELECT
      CASE
      WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0
      ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())::INTEGER
      END
      AS lag,
      CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END as is_replica;
    metrics:
    - lag:
        usage: "GAUGE"
    - is_replica:
        usage: "GAUGE"

persistance:
  enabled: true
  size: 100Mi
```
ãã®æ¬¡ã«å®Ÿéš›ã«ã€Postgresqlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚
```
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update bitnami
kubectl create namespace database
helm upgrade postgres bitnami/postgresql-ha \
  --install \
  --namespace database \
  --values=./values.yaml
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ä½œæˆ

values.yamlã«ä»¥ä¸‹ã®é …ç›®ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨ã§postgres-exporterã«ã¯ãªã„ç‹¬è‡ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml values.yaml
metrics:
  customMetrics:
    pg_replication:
      master: true
      query: |
        SELECT
        CASE
        WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0
        ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())::INTEGER
        END
        AS lag,
        CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END as is_replica;
      metrics:
        - lag:
          usage: "GAUGE"
        - is_replica:
          usage: "GAUGE"
```

ä½œæˆã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹åã¨ã—ã¦ã¯ã€`pg_replication_is_replica`ã«ã¦æ¤œç´¢ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  

### Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹

ä»Šå›ä½¿ç”¨ã™ã‚‹postgres-exporterã«ã¯ã€è¤‡æ•°Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒGrafanaã®ã‚µã‚¤ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€åŸºæœ¬çš„ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ã¤ã„ã¦ã¯ãã‚Œã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ã€‚ãŸã ã€ä»Šå›è¿½åŠ ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ã¤ã„ã¦ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€Grafanaã§ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
https://github.com/prometheus-community/postgres_exporter

#### Multiple Primariesã‚’æ¤œçŸ¥ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹

`pg_replication_is_replica`ã§æ¤œç´¢ã™ã‚‹ã¨ã€å„Podã”ã¨ã®Replicaã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒç¢ºèªã§ãã¾ã™ã€‚
![](/images/175dd79cea0fa7/the_num_of_replicas.png)

ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚ã¨ã„ã£ã¦ã‚‚ã€è¤‡é›‘ãªã“ã¨ã¯ç‰¹ã«ã›ãšã€å€¤ãŒï¼(Primary)ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ•°ã‚’æ•°ãˆã‚‹ã ã‘ã§ã™ã€‚  
![](/images/175dd79cea0fa7/dashboard.png)

ä¿å­˜ã—ãŸå¾Œã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ã“ã¡ã‚‰ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¡¨ç¤ºã—ã¦ã„ã‚‹å€¤ãŒï¼•åˆ†ä»¥ä¸Šé€£ç¶šã—ã¦ï¼’ä»¥ä¸Šã®æ™‚ã«é€šçŸ¥ã™ã‚‹ã‚‚ã®ã‚’ä½œæˆã—ã¾ã™ã€‚  
![](/images/175dd79cea0fa7/alert.png)
![](/images/175dd79cea0fa7/alert_2.png)

### æœ€å¾Œã«

Prometheusã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€å½“åˆã®å•é¡Œã§ã‚ã£ãŸPostgresqlã®è¤‡æ•°ã®Primaryã‚’æ¤œçŸ¥ã—ã€ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚æœ¬æ¥ã§ã‚ã‚Œã°ã€è‡ªå‹•çš„ã«æ¤œçŸ¥ã—ã¦ä¿®å¾©ã¾ã§å‡ºæ¥ã‚Œã°é‹ç”¨ã®è² è·ã¨ã—ã¦ã¯æ¸›ã‚‹ã®ã§ãã“ã¾ã§ä½œã‚Œã‚Œã°ã‚ˆã‹ã£ãŸã®ã§ã™ãŒã€ç¾çŠ¶ã ã¨é€šçŸ¥ã¾ã§ã®å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚Postgresqlã®Operatorã‚’å°å…¥ã§ãã‚Œã°ã€ãã“ã¾ã§å®Ÿç¾ã§ããã†ãªæ°—ãŒã™ã‚‹ã®ã§ã€æ¬¡å›ã¯ãã¡ã‚‰ã«æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
https://github.com/CrunchyData/postgres-operator
https://github.com/zalando/postgres-operator

èªè­˜é•ã„ã‚„ä¸æ­£ç¢ºãªç‚¹ãªã©ã‚ã‚Œã°ã€ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æŒ‡æ‘˜ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨éå¸¸ã«åŠ©ã‹ã‚Šã¾ã™ã€‚
ãã‚Œã§ã¯ã€ä»Šå›ã¯ã“ã“ã¾ã§ã€‚
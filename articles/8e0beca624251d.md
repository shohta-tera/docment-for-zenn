---
title: "K8ssandraã«ã¤ã„ã¦ã„ã‚‹Prometheusã‚’ä½¿ç”¨ã›ãšã€Grafanaã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes", "helm", "grafana", "prometheus"]
published: false
---

# ã¯ã˜ã‚ã«

Apache Cassandraã‚’Kubernetesã«æœ€é©åŒ–ã—ãŸã€K8ssandraã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚  
K8ssandraã«ã¯Apache Cassandraã®ä»–ã«ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãŸã‚ã®`Medusa`ã€è‡ªç«‹ä¿®å¾©ã®ãŸã‚ã®`Reaper`ã€ãã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã®ãŸã‚ã®`Prometheus`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚ï¼ˆHelmçµŒç”±ï¼‰  
ä»Šå›ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸç’°å¢ƒã§ã¯ã€`Prometheus`ã‚„`Grafana`ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãŠã‚Šã€ãã¡ã‚‰ã‚’ä½¿ã„ã¾ã‚ã—ãŸã„ãŸã‚ã€Helmãƒãƒ£ãƒ¼ãƒˆã®å€¤ã‚’ä¸€éƒ¨å¤‰æ›´ã—ã¦K8ssandraã«ä»˜å±ã®`Prometheus`ãªã©ã‚’ä½¿ç”¨ã—ãªã„ã‚ˆã†ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã—ãŸã€‚

## ç’°å¢ƒ

- WSL2: Ubuntu 20
- Docker: 4.10.1
- kind: kind v0.11.1 go1.16.4 linux/amd64

### Kubernetesã®ç”¨æ„

`kind create cluster`
ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€Kindã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ç”¨æ„ã—ã¾ã™ã€‚

## K8ssandraã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### Helmãƒãƒ£ãƒ¼ãƒˆãƒ¬ãƒã‚¸ãƒˆãƒªã®è¿½åŠ 

```
helm repo add k8ssandra https://helm.k8ssandra.io/stable
helm repo update
```

### Namespaceã®è¿½åŠ 
`kubectl create namespace database`

*Output:*
```
namespace/database created
```

### K8ssandraã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
äº‹å‰ã«è¨­å®šã‚’Overrideã™ã‚‹ãŸã‚ã®ã€yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãŠãã¾ã™
```yaml
---
stargate:
  enabled: false
```
ã“ã“ã§ã€Cassandraã®REST APIã‚„GraphQLã®APIã‚’æä¾›ã™ã‚‹Stargateã¯ä»Šå›ä½¿ç”¨ã—ãªã„ã®ã§ã€ç„¡åŠ¹åŒ–ã—ã¦ãŠãã¾ã™ã€‚

`helm upgrade k8ssandra k8ssandra/k8ssandra --install -n database -f values.yaml`

*output:(kubectl get pods -n database)*
```
NAME                                                 READY   STATUS    RESTARTS   AGE
k8ssandra-cass-operator-6768bfc4f5-s7tgd             1/1     Running   0          14m
k8ssandra-dc1-default-sts-0                          2/2     Running   0          14m
k8ssandra-dc1-stargate-75b547df5f-bq4bg              1/1     Running   2          14m
k8ssandra-grafana-5d56cd88d4-2lr9v                   2/2     Running   0          14m
k8ssandra-kube-prometheus-operator-f9b7fddd7-vkbrg   1/1     Running   0          14m
k8ssandra-reaper-f68946d94-bbv8b                     1/1     Running   0          7m58s
k8ssandra-reaper-operator-5cd57fb5fd-sl2k8           1/1     Running   0          14m
prometheus-k8ssandra-kube-prometheus-prometheus-0    2/2     Running   0          13m
```

## Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã‚‹

ã‚‚ã—ã€Kubernetesã®ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ã€Lensã‚’ä½¿ç”¨ã—ã¦ã„ã‚Œã°ã€Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã®ã¯ç°¡å˜ã§ã™ã€‚
![](/images/8e0beca624251d/grafana.png)

`k8ssandra-grafana`ã¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒã¤ã„ã¦ã„ã‚‹Podã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Port3000ç•ªã‚’Localhostã«é–‹æ”¾ã™ã‚‹ã ã‘ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

![](/images/8e0beca624251d/cassandra_condensed.png)

ä¸Šè¨˜ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä¸€ä¾‹ã§ã™ã€‚

## Prometheusã¨Grafanaã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

å…ˆã»ã©ä½œæˆã—ãŸã€values.yamlã«è¿½è¨˜ã—ã¾ã™ã€‚

https://github.com/shohta-tera/k8ssandra-with-external-prometheus-and-grafana/blob/e2804c62237cb2b8b3ff5809d7f4eeec52ee16f2/k8ssandra/values.yaml

å†åº¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰Prometheusã¨Grafanaã‚’ç„¡åŠ¹åŒ–ã§ãã¾ã—ãŸã€‚

`helm upgrade k8ssandra k8ssandra/k8ssandra --install -n database -f values.yaml`

## K8ssandraç®¡ç†å¤–ã®Prometheusã¨Grafanaã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

æœ¬æ¥ã§ã‚ã‚Œã°ã€äº‹å‰ã«ã‚ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã‚’æµç”¨ã™ã‚‹ã®ã§ã™ãŒã€ä»Šå›ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‹ã‚‰æ§‹ç¯‰ã—ã¦ã„ã‚‹ã®ã§Prometheusã¨Grafanaã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚  
ã‚‚ã—ã€ã™ã§ã«ã‚ã‚‹ã®ã§ã‚ã‚Œã°èª­ã¿é£›ã°ã—ã¦ãã ã•ã„ã€‚

### Prometheus

```
kubectl create namespace monitoring
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm upgrade prometheus prometheus-community/prometheus --install -n monitoring
```

### Grafana

ã“ã¡ã‚‰ã‚‚Grafanaç”¨ã«è¨­å®šã‚’Overrideã™ã‚‹ãŸã‚ã®yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  

https://github.com/shohta-tera/k8ssandra-with-external-prometheus-and-grafana/blob/e2804c62237cb2b8b3ff5809d7f4eeec52ee16f2/grafana/values.yaml

ä¸Šè¨˜ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€Grafanaã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Prometheusã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã«è¡Œãã¾ã™ã€‚  


```
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm upgrade grafana grafana/grafana --install -n monitoring -f grafana-values.yaml
```

## K8ssandraã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦Prometheusã«æ ¼ç´ã™ã‚‹

Prometheusã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ã€K8ssandraã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚  
K8ssandraã«ã¯ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç”¨ã®ãƒãƒ¼ãƒˆã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã€ãã“ã‹ã‚‰å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
![](/images/8e0beca624251d/cassandra_pod.png)

- Port: 9103
- path: /metrics
ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ä¸Šè¨˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

ä¸‹è¨˜ã¯å–å¾—å¯èƒ½ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ä¸€ä¾‹ã€‚

```
# HELP collectd_load_longterm write_prometheus plugin: 'load' Type: 'load', Dstype: 'gauge', Dsname: 'longterm'
# TYPE collectd_load_longterm gauge
collectd_load_longterm{instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 1.17 1658160223972
# HELP collectd_load_midterm write_prometheus plugin: 'load' Type: 'load', Dstype: 'gauge', Dsname: 'midterm'
# TYPE collectd_load_midterm gauge
collectd_load_midterm{instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 0.81 1658160223972
# HELP collectd_load_shortterm write_prometheus plugin: 'load' Type: 'load', Dstype: 'gauge', Dsname: 'shortterm'
# TYPE collectd_load_shortterm gauge
collectd_load_shortterm{instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 0.48 1658160223972
# HELP collectd_mcac_counter_total write_prometheus plugin: 'mcac' Type: 'counter', Dstype: 'counter', Dsname: 'value'
# TYPE collectd_mcac_counter_total counter
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_message_size.bytes_received",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 186814 1658160208850
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_message_size.bytes_sent",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 1043279 1658160208795
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_request.condition_not_met.cas_write",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 0 1658160208672
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_request.total_latency.cas_read",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 0 1658160208957
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_request.total_latency.cas_write",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 262056 1658160208767
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_request.total_latency.range_slice",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 2088099 1658160208926
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_request.total_latency.read",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 551045 1658160208745
collectd_mcac_counter_total{mcac="org.apache.cassandra.metrics.client_request.total_latency.read.all",instance="10.244.1.13",cluster="k8ssandra",dc="dc1",rack="default"} 0 1658160208735
```

ã“ã“ã§ã€Cassandraã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯ã€MCAC(Metrics Collector for Apache Cassandra)ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚  
ã“ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã®ã¾ã¾Prometheusã«ä¿å­˜ã—ã¦ã‚‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯æç”»ã•ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ã“ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ã¤ã„ã¦ã¯ãƒ©ãƒ™ãƒ«ã®å¤‰æ›ãŒå¿…è¦ã§ã™ã€‚  
ãƒ©ãƒ™ãƒ«å¤‰æ›ã«ã¤ã„ã¦ã¯ã€[K8ssandraã®Helmãƒãƒ£ãƒ¼ãƒˆ](https://github.com/datastax/metric-collector-for-apache-cassandra/blob/master/config/metric-collector.yaml)ã«ã‚ã‚Šã¾ã™ã®ã§ã€ãã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦Prometheusã®è¨­å®šã‚’ã—ã¦ã„ãã¾ã™ã€‚

https://github.com/shohta-tera/k8ssandra-with-external-prometheus-and-grafana/blob/e2804c62237cb2b8b3ff5809d7f4eeec52ee16f2/prometheus/values.yaml

å†åº¦ã€Prometheusã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

`helm upgrade prometheus prometheus-community/prometheus --install -n monitoring -f prometheus-values.yaml`

è¨­å®šå¤‰æ›´ãŒæˆåŠŸã—ã¦ã„ã‚‹ã¨ã€Prometheusã®ãƒšãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰åŒ–ã—ã€PrometheusãŒå®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](/images/8e0beca624251d/prometheus.png)

### Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

K8ssandraã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯Grafanaã«ã¯ç™»éŒ²ã•ã‚Œã¦ãŠã‚‰ãšã€[K8ssandraã®Helmãƒãƒ£ãƒ¼ãƒˆã®ãƒ¬ãƒã‚¸ãƒˆãƒª](https://github.com/k8ssandra/k8ssandra/tree/main/charts/k8ssandra/dashboards)ã«ã‚ã‚Šã¾ã™ã€‚  

å…ˆã®ãƒªãƒ³ã‚¯å…ˆã®ã†ã¡ã€ã©ã‚Œã‹ä¸€ã¤ã‚’é¸æŠã—ã¦Grafanaã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã¿ã¾ã™ã€‚

![](/images/8e0beca624251d/grafana-import.png)

Importã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨JSONã‚’å…¥åŠ›ã™ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã®ã§ã€ãã¡ã‚‰ã«Githubã‚ˆã‚Šå–å¾—ã—ãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®JSONã‚’è²¼ã‚Šä»˜ã‘ã—ã¾ã™ã€‚

ã†ã¾ãã„ãã¨ä»¥ä¸‹ã®ã‚ˆã†ã«Cassandraã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚


![](/images/8e0beca624251d/grafana-dashboard.png)


## ãŠã‚ã‚Šã«

K8ssandraã®ã‚¹ã‚¿ãƒƒã‚¯å¤–ã«ã™ã§ã«å­˜åœ¨ã™ã‚‹Prometheusã‚„Grafanaã‚’ä½¿ç”¨ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¦ã¿ã¾ã—ãŸã€‚  
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ã‚‚ã€K8ssandraã®ã‚¹ã‚¿ãƒƒã‚¯ã«å­˜åœ¨ã™ã‚‹Prometheusã‚„Grafanaã®äº‹ã°ã‹ã‚Šã§ã€å¤–éƒ¨ã®ã‚’åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã¯ã¾ã£ãŸãã¨è¨€ã£ã¦ã„ã„ã»ã©ãªã‹ã£ãŸã®ã§ã€ä»Šå›è¨˜äº‹ã«ã—ã¦ã¿ã¾ã—ãŸã€‚  
K8ssandraã®ã‚¹ã‚¿ãƒƒã‚¯ç”¨ã«Prometheusã‚’åˆ¥é€”ç«‹ã¦ã‚‹ã®ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®åŠ¹ç‡é¢ã‹ã‚‰ã¿ã¦è‰¯ããªãã€æ—¢å­˜ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½¿ã„ã¾ã‚ã—ãŸã„ãªã©ã¯ã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã£ã¦ã„ã¾ã™ã€‚  
ãã®ã‚ˆã†ãªäººã«ã¨ã£ã¦ã“ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚‹ã¨å¹¸ã„ã§ã™ã€‚  
æŒ‡æ‘˜ã‚„ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã‚ã‚Šã¾ã—ãŸã‚‰å¾…ã£ã¦ã„ã¾ã™ï¼

### å‚è€ƒãƒªãƒ³ã‚¯
- k8ssandra: https://k8ssandra.io/